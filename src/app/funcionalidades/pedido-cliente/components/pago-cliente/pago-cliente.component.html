<!-- Navegación Pedido QR -->
<nav class="sticky top-0 z-30 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 border-b border-secondary-100">
  <div class="container mx-auto px-4 py-3 flex flex-wrap items-center gap-2 text-sm">
    <a [routerLink]="['../']" routerLinkActive="!bg-primary-600 !text-white" [routerLinkActiveOptions]="{ exact: true }"
       class="px-3 py-1.5 rounded-lg font-medium text-primary-700 hover:bg-primary-50 transition">Registro</a>
    <a [routerLink]="['../menu']" routerLinkActive="!bg-primary-600 !text-white"
       class="px-3 py-1.5 rounded-lg font-medium text-primary-700 hover:bg-primary-50 transition">Menú</a>
    <a [routerLink]="['./']" routerLinkActive="!bg-primary-600 !text-white" [routerLinkActiveOptions]="{ exact: true }"
       class="px-3 py-1.5 rounded-lg font-medium text-primary-700 hover:bg-primary-50 transition">Pago</a>
    <a [routerLink]="['../confirmacion']" routerLinkActive="!bg-primary-600 !text-white"
       class="px-3 py-1.5 rounded-lg font-medium text-primary-700 hover:bg-primary-50 transition">Confirmación</a>
    <span class="ms-auto text-secondary-600">Paso 3 de 4</span>
  </div>
</nav>
<div class="w-full min-h-screen bg-gradient-to-br from-secondary-50 to-primary-100 flex items-center justify-center p-4 animate-fade-in">
  <div class="w-full max-w-lg mx-auto">

    <!-- Cabecera -->
    <header class="text-center mb-8">
      <h1 class="font-display text-4xl md:text-5xl font-bold text-secondary-800">Casi listo...</h1>
      <p class="text-secondary-500 mt-1 text-lg">Revisa tu pedido antes de confirmar.</p>
      <p class="text-secondary-600 mt-2" *ngIf="pedidoState?.cliente">
        Hola, <span class="font-semibold">{{ pedidoState.cliente?.nombre }}</span>
        <span *ngIf="pedidoState.cliente?.telefono"> ({{ pedidoState.cliente?.telefono }})</span>
      </p>
    </header>

    <!-- Panel Principal -->
    <div class="bg-white/80 backdrop-blur-lg rounded-2xl shadow-lg overflow-hidden">
      <div class="p-6 md:p-8">
        <!-- Datos del cliente -->
        <div class="mb-5 p-4 rounded-xl ring-1 ring-secondary-200 bg-white/70" *ngIf="pedidoState">
          <div class="text-sm text-secondary-600 mb-2 font-semibold">Tus datos</div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-secondary-700">
            <div><span class="text-secondary-500">Nombre:</span> {{ pedidoState.cliente?.nombre || '-' }}</div>
            <div><span class="text-secondary-500">Teléfono:</span> {{ pedidoState.cliente?.telefono || '-' }}</div>
            <div><span class="text-secondary-500">Área:</span> {{ pedidoState.area || '-' }}</div>
            <div><span class="text-secondary-500">Mesa:</span> {{ pedidoState.mesaId || '-' }}</div>
          </div>
          <div *ngIf="mesaEstado" class="mt-3 flex items-center gap-3 text-sm">
            <span class="text-secondary-600">Estado de la mesa:</span>
            <span
              class="px-2 py-0.5 rounded-full text-white text-xs"
              [ngClass]="mesaEstado.estado === 'ocupada' ? 'bg-amber-600' : 'bg-emerald-600'"
            >
              {{ mesaEstado.estado || 'desconocido' }}
            </span>
            <span *ngIf="mesaEstado.pedidoEstado" class="px-2 py-0.5 rounded-full text-xs"
                  [ngClass]="mesaEstado.pagado ? 'bg-emerald-100 text-emerald-800' : 'bg-amber-100 text-amber-800'">
              pedido: {{ mesaEstado.pedidoEstado }}
            </span>
          </div>
        </div>

        <h2 class="text-xl font-bold text-secondary-800 mb-5">Resumen del Pedido</h2>

        <!-- Lista de Items -->
        <div class="space-y-3 max-h-64 overflow-y-auto pr-2 custom-scrollbar">
          <div *ngFor="let item of pedidoState.items | keyvalue" class="flex justify-between items-center text-secondary-700">
            <div>
              <p class="font-semibold">{{ item.value.nombre }}</p>
              <p class="text-sm text-secondary-500">{{ item.value.cantidad }} x {{ item.value.precio | currency:'$' }}</p>
            </div>
            <p class="font-bold text-secondary-800">{{ (item.value.cantidad * item.value.precio) | currency:'$' }}</p>
          </div>
        </div>

        <!-- Divisor -->
        <div class="border-t-2 border-dashed border-secondary-200 my-5"></div>

        <!-- Total -->
        <div class="flex justify-between items-center mb-6">
          <p class="text-lg font-bold text-secondary-600">Total a pagar:</p>
          <p class="font-display text-4xl font-extrabold text-primary-600">{{ pedidoState.total | currency:'$' }}</p>
        </div>

        <!-- Métodos de pago (demo) -->
        <div class="mb-6">
          <h3 class="text-lg font-semibold text-secondary-800 mb-3">Elegí un método de pago</h3>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
            <button type="button"
                    (click)="selectedMetodo = 'tarjeta'"
                    [ngClass]="selectedMetodo === 'tarjeta' ? 'ring-2 ring-primary-400 bg-primary-50' : 'ring-1 ring-secondary-200 bg-white'"
                    class="w-full p-4 rounded-xl text-left hover:bg-primary-50 transition">
              <div class="font-medium text-secondary-800">Tarjeta</div>
              <div class="text-xs text-secondary-500">Crédito/Débito</div>
            </button>
            <button type="button"
                    (click)="selectedMetodo = 'mercado_pago'"
                    [ngClass]="selectedMetodo === 'mercado_pago' ? 'ring-2 ring-primary-400 bg-primary-50' : 'ring-1 ring-secondary-200 bg-white'"
                    class="w-full p-4 rounded-xl text-left hover:bg-primary-50 transition">
              <div class="font-medium text-secondary-800">Mercado Pago</div>
              <div class="text-xs text-secondary-500">QR (Demo)</div>
            </button>
            <button type="button"
                    (click)="selectedMetodo = 'transferencia'"
                    [ngClass]="selectedMetodo === 'transferencia' ? 'ring-2 ring-primary-400 bg-primary-50' : 'ring-1 ring-secondary-200 bg-white'"
                    class="w-full p-4 rounded-xl text-left hover:bg-primary-50 transition">
              <div class="font-medium text-secondary-800">Transferencia</div>
              <div class="text-xs text-secondary-500">Datos ficticios</div>
            </button>
          </div>

          <!-- Form Tarjeta (demo) -->
          <div *ngIf="selectedMetodo === 'tarjeta'" class="space-y-3 bg-white/70 p-4 rounded-xl ring-1 ring-secondary-200">
            <div>
              <label class="block text-sm text-secondary-600 mb-1">Nombre en la tarjeta</label>
              <input [(ngModel)]="cardForm.nombre" placeholder="Juan P. Ejemplo" class="w-full px-3 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-300" />
            </div>
            <div>
              <label class="block text-sm text-secondary-600 mb-1">Número</label>
              <input [(ngModel)]="cardForm.numero" placeholder="4111 1111 1111 1111" class="w-full px-3 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-300" />
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm text-secondary-600 mb-1">Vencimiento (MM/AA)</label>
                <input [(ngModel)]="cardForm.vencimiento" placeholder="12/29" class="w-full px-3 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-300" />
              </div>
              <div>
                <label class="block text-sm text-secondary-600 mb-1">CVV</label>
                <input [(ngModel)]="cardForm.cvv" placeholder="123" class="w-full px-3 py-2 rounded-lg border border-secondary-200 focus:outline-none focus:ring-2 focus:ring-primary-300" />
              </div>
            </div>
            <p class="text-xs text-secondary-500">Esta es una simulación. No se procesará ningún pago real.</p>
          </div>

          <!-- Mercado Pago QR (demo) -->
          <div *ngIf="selectedMetodo === 'mercado_pago'" class="bg-white/70 p-4 rounded-xl ring-1 ring-secondary-200">
            <div class="flex items-center gap-4">
              <div class="w-28 h-28 bg-secondary-100 grid place-content-center rounded-lg">
                <!-- Placeholder de QR -->
                <div class="w-24 h-24 bg-secondary-200 grid place-content-center text-secondary-600 text-xs">QR DEMO</div>
              </div>
              <div>
                <div class="font-semibold text-secondary-800">Escaneá para pagar</div>
                <div class="text-sm text-secondary-600">Monto: {{ pedidoState.total | currency:'$' }}</div>
                <div class="text-xs text-secondary-500">Este QR es ilustrativo (sin integración real).</div>
              </div>
            </div>
          </div>

          <!-- Transferencia (demo) -->
          <div *ngIf="selectedMetodo === 'transferencia'" class="bg-white/70 p-4 rounded-xl ring-1 ring-secondary-200 space-y-2">
            <div class="text-sm"><span class="font-medium">Alias:</span> {{ transferenciaDatos.alias }}</div>
            <div class="text-sm"><span class="font-medium">CBU:</span> {{ transferenciaDatos.cbu }}</div>
            <div class="text-sm"><span class="font-medium">Titular:</span> {{ transferenciaDatos.titular }}</div>
            <div class="text-sm"><span class="font-medium">Banco:</span> {{ transferenciaDatos.banco }}</div>
            <div class="pt-2">
              <label class="block text-sm text-secondary-600 mb-1">Comprobante de transferencia</label>
              <input type="file" (change)="onTransferenciaFileSelected($event)" accept="image/*,application/pdf" class="block w-full text-sm text-secondary-700 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100" />
              <div *ngIf="transferenciaComprobanteNombre" class="text-xs text-secondary-600 mt-1">Archivo: {{ transferenciaComprobanteNombre }}</div>
              <p class="text-xs text-secondary-500 mt-1">Subí una foto o PDF del comprobante para continuar.</p>
            </div>
          </div>
        </div>

        <!-- Mensaje de Error -->
        <div *ngIf="errorMessage" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg mb-6 animate-fade-in" role="alert">
          <p class="font-bold">¡Ups! Algo salió mal</p>
          <p>{{ errorMessage }}</p>
        </div>

        <!-- Botón de Acción -->
        <button (click)="confirmarPedido()" [disabled]="isLoading"
                class="w-full bg-primary-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-primary-700 focus:outline-none focus:ring-4 focus:ring-primary-300 disabled:bg-primary-300 disabled:cursor-not-allowed transform hover:-translate-y-1 transition-all duration-300 shadow-lg hover:shadow-primary-400/40 flex items-center justify-center h-16">
          <span *ngIf="!isLoading" class="text-lg">
            {{ selectedMetodo === 'tarjeta' ? 'Pagar con Tarjeta (demo)'
               : selectedMetodo === 'mercado_pago' ? 'Confirmar Pago por Mercado Pago (demo)'
               : selectedMetodo === 'transferencia' ? 'He realizado la transferencia (demo)'
               : 'Confirmar y Pagar Ahora' }}
          </span>
          <div *ngIf="isLoading" class="flex items-center gap-3">
            <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="text-lg">Procesando...</span>
          </div>
        </button>
      </div>
    </div>

  </div>
</div>
