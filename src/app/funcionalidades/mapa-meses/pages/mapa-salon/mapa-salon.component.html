<mat-card>
  <mat-card-title>Mapa de Mesas</mat-card-title>
  <mat-card-subtitle>Arrastra y suelta para reubicar mesas. Los cambios se guardan automáticamente.</mat-card-subtitle>

  <div class="acciones flex flex-wrap items-center gap-2 mb-4">
    <button mat-raised-button color="primary" (click)="agregarMesa()" *ngIf="rol !== 'mozo'">
      <mat-icon>add</mat-icon> Agregar mesa
    </button>
    <button mat-button color="warn" (click)="resetearMapa()" *ngIf="rol !== 'mozo'">
      <mat-icon>refresh</mat-icon> Resetear mapa
    </button>
    <span class="flex-1"></span>
    <mat-button-toggle-group class="shrink-0" [(ngModel)]="modo" (change)="onCambioModo()" *ngIf="rol !== 'mozo'">
      <mat-button-toggle value="seleccion"><mat-icon>mouse</mat-icon> Selección</mat-button-toggle>
      <mat-button-toggle value="dibujo"><mat-icon>gesture</mat-icon> Dibujo</mat-button-toggle>
    </mat-button-toggle-group>
    <div class="flex items-center gap-2 mx-2" *ngIf="rol !== 'mozo'">
      <label>Color:</label>
      <input type="color" [(ngModel)]="brushColor"/>
      <mat-form-field appearance="outline" class="w-24">
        <mat-label>Grosor</mat-label>
        <mat-select [(ngModel)]="brushWidth">
          <mat-option [value]="2">2</mat-option>
          <mat-option [value]="4">4</mat-option>
          <mat-option [value]="6">6</mat-option>
          <mat-option [value]="8">8</mat-option>
          <mat-option [value]="10">10</mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-stroked-button color="warn" (click)="borrarAnotacionesArea()">
        <mat-icon>layers_clear</mat-icon> Borrar marcas área
      </button>
    </div>
    <mat-button-toggle-group class="shrink-0" [(ngModel)]="areaActiva" (change)="onCambioArea()">
      <mat-button-toggle value="interior"><mat-icon>store</mat-icon> Interior</mat-button-toggle>
      <mat-button-toggle value="exterior"><mat-icon>deck</mat-icon> Exterior</mat-button-toggle>
    </mat-button-toggle-group>
    <mat-checkbox class="ml-2" [(ngModel)]="permitirEditarExterior" (change)="onCambio()" *ngIf="rol !== 'mozo'">
      Permitir editar afuera
    </mat-checkbox>
    <mat-checkbox class="ml-2" [(ngModel)]="snapToGrid" (change)="onCambio()" *ngIf="rol !== 'mozo'">Snap a grilla</mat-checkbox>
    <mat-form-field appearance="outline" class="w-28 ml-2" *ngIf="rol !== 'mozo'">
      <mat-label>Grilla</mat-label>
      <input matInput type="number" min="5" max="200" [(ngModel)]="gridSize" (ngModelChange)="onCambio()" />
    </mat-form-field>
  </div>

  <div class="layout grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="canvas lg:col-span-2 relative rounded-2xl border border-gray-200 bg-white shadow-sm overflow-hidden" [style.width.px]="ancho" [style.height.px]="alto">
      <!-- Overlay SVG para dibujo -->
      <svg class="overlay" [attr.width]="ancho" [attr.height]="alto"
           (mousedown)="onSvgDown($event)" (mousemove)="onSvgMove($event)" (mouseup)="onSvgUp()"
           [style.pointer-events]="modo === 'dibujo' ? 'auto' : 'none'"
           [style.cursor]="modo === 'dibujo' ? 'crosshair' : 'default'">
        <g>
          <path *ngFor="let a of anotacionesArea" [attr.d]="a.d" [attr.stroke]="a.color" [attr.stroke-width]="a.width" fill="none" stroke-linecap="round" stroke-linejoin="round"></path>
          <path *ngIf="dibujoEnCurso" [attr.d]="dibujoEnCurso" [attr.stroke]="brushColor" [attr.stroke-width]="brushWidth" fill="none" stroke-linecap="round" stroke-linejoin="round"></path>
        </g>
      </svg>
      <div class="mesa"
           *ngFor="let mesa of mesasArea"
           cdkDrag
           (click)="seleccionarMesa(mesa)"
           [class.seleccionada]="seleccionada?.id === mesa.id"
           [class.bloqueada]="rol==='mozo' || !puedeEditarMesa(mesa)"
           [style.width.px]="mesa.ancho || 120"
           [style.height.px]="mesa.alto || (mesa.forma === 'redonda' ? (mesa.ancho || 100) : 90)"
           [style.background]="mesa.color || '#fff'"
           [style.transform]="mesa.rotationDeg ? 'rotate(' + mesa.rotationDeg + 'deg)' : null"
           [cdkDragFreeDragPosition]="{x: mesa.x, y: mesa.y}"
           [cdkDragDisabled]="rol==='mozo' || !puedeEditarMesa(mesa)"
           (cdkDragEnded)="onDragEnded($event, mesa)"
           [ngClass]="{
            'redonda': mesa.forma === 'redonda',
            'cuadrada': mesa.forma === 'cuadrada',
            'rectangular': mesa.forma === 'rectangular',
            'dinosaurio': mesa.forma === 'dinosaurio',
            'estado-ocupada': (estadoMesas.get(mesa.id)?.estado === 'ocupada'),
            'estado-libre': (estadoMesas.get(mesa.id)?.estado !== 'ocupada')
           }">
        <div class="mesa-header">
          <div class="nombre">{{ mesa.nombre }}</div>
          <span class="acciones-mesa">
            <button mat-stroked-button color="primary" (click)="$event.stopPropagation(); atenderMesa(mesa)" *ngIf="rol !== 'mozo'">
              <mat-icon>restaurant</mat-icon>
              Atender
            </button>
            <button mat-icon-button color="primary" (click)="$event.stopPropagation(); duplicarMesa(mesa)" *ngIf="rol !== 'mozo'">
              <mat-icon>content_copy</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="$event.stopPropagation(); eliminarMesa(mesa.id)" *ngIf="rol !== 'mozo'">
              <mat-icon>delete</mat-icon>
            </button>
          </span>
        </div>
        <div class="detalles">
          Cap.: {{ mesa.capacidad }} – {{ mesa.forma }}
          <span class="chip ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium" [class.ocupada]="estadoMesas.get(mesa.id)?.estado === 'ocupada'">
            {{ estadoMesas.get(mesa.id)?.estado === 'ocupada' ? 'Ocupada' : 'Libre' }}
          </span>
        </div>
        <div class="dino" *ngIf="mesa.forma === 'dinosaurio'"></div>
      </div>
      <div *ngIf="mesasArea.length === 0" class="absolute inset-0 flex items-center justify-center text-gray-500">
        <div class="text-center">
          <div class="font-semibold">No hay mesas para el área "{{ areaActiva }}"</div>
          <div class="text-xs">Si el backend aún no tiene layout guardado, se muestra el local.</div>
        </div>
      </div>
    </div>

    <div class="panel lg:col-span-1 lg:sticky lg:top-4 h-fit rounded-2xl border border-gray-200 bg-white/60 backdrop-blur-sm p-4" *ngIf="seleccionada as m" [hidden]="rol==='mozo'">
      <h3>Editar mesa</h3>
      <div class="panel-campos">
        <mat-form-field appearance="outline">
          <mat-label>Nombre</mat-label>
          <input matInput [(ngModel)]="m.nombre" (ngModelChange)="onCambio()" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Capacidad</mat-label>
          <input matInput type="number" min="1" [(ngModel)]="m.capacidad" (ngModelChange)="onCambio()" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Forma</mat-label>
          <mat-select [(value)]="m.forma" (selectionChange)="onCambio()">
            <mat-option value="cuadrada">Cuadrada</mat-option>
            <mat-option value="rectangular">Rectangular</mat-option>
            <mat-option value="redonda">Redonda</mat-option>
            <mat-option value="dinosaurio">Dinosaurio</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="fila" *ngIf="m.forma !== 'redonda'">
          <mat-form-field appearance="outline">
            <mat-label>Ancho (px)</mat-label>
            <input matInput type="number" min="40" [(ngModel)]="m.ancho" (ngModelChange)="onCambio()" />
          </mat-form-field>
          <mat-form-field appearance="outline" *ngIf="m.forma === 'rectangular' || m.forma === 'cuadrada'">
            <mat-label>Alto (px)</mat-label>
            <input matInput type="number" min="40" [(ngModel)]="m.alto" (ngModelChange)="onCambio()" />
          </mat-form-field>
        </div>

        <div class="color-picker">
          <label>Color: </label>
          <input type="color" [(ngModel)]="m.color" (change)="onCambio()" />
        </div>

        <mat-form-field appearance="outline" *ngIf="m.forma === 'rectangular' || m.forma === 'cuadrada'">
          <mat-label>Rotación (°)</mat-label>
          <input matInput type="number" min="0" max="359" [(ngModel)]="m.rotationDeg" (ngModelChange)="onCambio()" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Área</mat-label>
          <mat-select [(ngModel)]="m.area" (ngModelChange)="onCambio()">
            <mat-option [value]="'interior'">Interior</mat-option>
            <mat-option [value]="'exterior'">Exterior</mat-option>
          </mat-select>
        </mat-form-field>

        <div class="acciones-panel">
          <button mat-stroked-button color="primary" (click)="duplicarMesa(m)"><mat-icon>content_copy</mat-icon> Duplicar</button>
          <button mat-stroked-button color="warn" (click)="eliminarMesa(m.id)"><mat-icon>delete</mat-icon> Eliminar</button>
        </div>
      </div>
    </div>
  </div>
</mat-card>
